import os
import pandas as pd
import numpy as np

def generate_yoy_report(path_detail):
    years = [2023, 2024, 2025]
    data = {}

    # Load yearly files (supporting TAB or COMMA)
    for yr in years:
        file = f"{path_detail}/data_{yr}.csv"
        if os.path.exists(file):
            df = pd.read_csv(
                file,
                sep=r"[\t,]",        # auto handle tab or comma
                engine="python",
                header=None,
                names=[f"DATE_{yr}", str(yr)]
            )
            data[yr] = df
        else:
            print(f"âš ï¸ Missing file: {file}")
            return None

    # Merge all 3 years side-by-side by row position
    merged = pd.concat([data[2023], data[2024], data[2025]], axis=1)

    # Replace NaN with 0 for calculation
    merged = merged.replace({np.nan: 0})

    # Convert YoY columns to numeric
    merged["2023"] = pd.to_numeric(merged["2023"], errors="coerce").fillna(0)
    merged["2024"] = pd.to_numeric(merged["2024"], errors="coerce").fillna(0)
    merged["2025"] = pd.to_numeric(merged["2025"], errors="coerce").fillna(0)

    # -------------------------------
    # Calculate YoY % changes
    # -------------------------------

    # Avoid division by zero
    merged["YoY_2025_vs_2023"] = np.where(
        merged["2023"] == 0,
        0,
        ((merged["2025"] - merged["2023"]) / merged["2023"]) * 100
    )

    merged["YoY_2025_vs_2024"] = np.where(
        merged["2024"] == 0,
        0,
        ((merged["2025"] - merged["2024"]) / merged["2024"]) * 100
    )

    # Round % values
    merged["YoY_2025_vs_2023"] = merged["YoY_2025_vs_2023"].round(1)
    merged["YoY_2025_vs_2024"] = merged["YoY_2025_vs_2024"].round(1)

    # -------------------------------
    # Add ğŸ“ˆ / ğŸ“‰ / ğŸš€ Icons
    # -------------------------------

    def add_icon(val):
        if val >= 500:
            return f"{val}% ğŸš€"
        elif val > 0:
            return f"{val}% ğŸ“ˆ"
        elif val < 0:
            return f"{val}% ğŸ“‰"
        else:
            return f"{val}%"

    merged["YoY_2025_vs_2023"] = merged["YoY_2025_vs_2023"].apply(add_icon)
    merged["YoY_2025_vs_2024"] = merged["YoY_2025_vs_2024"].apply(add_icon)

    # -------------------------------
    # Re-order columns as requested
    # -------------------------------

    final = merged[
        [
            "DATE_2023", "2023",
            "DATE_2024", "2024",
            "DATE_2025", "2025",
            "YoY_2025_vs_2023",
            "YoY_2025_vs_2024"
        ]
    ]

    # Save final file
    output_file = f"{path_detail}/YoY_Comparison_Report.csv"
    final.to_csv(output_file, index=False)

    print(f"âœ… YoY comparison report created successfully: {output_file}")
    return final
